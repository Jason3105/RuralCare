{% extends 'base.html' %}
{% block title %}Verify Prescription{% endblock %}

{% block content %}
<div class="min-h-screen bg-background py-8 fade-in">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <nav class="mb-4">
                <a href="{% url 'doctor_dashboard' %}" class="text-primary hover:underline text-sm">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                </a>
            </nav>
            <h1 class="text-3xl font-bold text-foreground flex items-center">
                <i class="fas fa-shield-alt text-primary mr-3"></i>
                Prescription Verification
            </h1>
            <p class="text-muted-foreground mt-2">
                Upload a prescription PDF to verify its authenticity against the blockchain record
            </p>
        </div>

        <!-- Messages -->
        {% if messages %}
        <div class="mb-6 space-y-2">
            {% for message in messages %}
            <div class="p-4 rounded-lg {% if message.tags == 'error' %}bg-red-500/10 border border-red-500/30 text-red-400{% else %}bg-green-500/10 border border-green-500/30 text-green-400{% endif %}">
                <i class="fas {% if message.tags == 'error' %}fa-exclamation-circle{% else %}fa-check-circle{% endif %} mr-2"></i>
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if verification_result %}
        <!-- Verification Result -->
        <div class="bg-card border border-border/50 rounded-xl p-6 mb-8">
            <div class="flex items-start space-x-4">
                {% if verification_result.verified %}
                <div class="flex-shrink-0 w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-check-circle text-green-500 text-3xl"></i>
                </div>
                <div class="flex-1">
                    <h2 class="text-2xl font-bold text-green-500 mb-2">Verified ✓</h2>
                    <p class="text-muted-foreground mb-4">This prescription is authentic and has not been tampered with.</p>
                {% else %}
                <div class="flex-shrink-0 w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-times-circle text-red-500 text-3xl"></i>
                </div>
                <div class="flex-1">
                    <h2 class="text-2xl font-bold text-red-500 mb-2">Verification Failed ✗</h2>
                    <p class="text-muted-foreground mb-4">This document does not match the original prescription record.</p>
                {% endif %}
                </div>
            </div>

            <!-- Verification Details -->
            <div class="mt-6 pt-6 border-t border-border/50">
                <h3 class="font-semibold text-foreground mb-4">Verification Details</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-accent/30 rounded-lg p-4">
                        <p class="text-sm text-muted-foreground mb-1">Verification Method</p>
                        <p class="font-medium text-foreground">
                            {% if verification_result.method == 'exact_hash' %}
                            <i class="fas fa-fingerprint text-green-500 mr-2"></i>Exact Hash Match
                            {% elif verification_result.method == 'blockchain_hash' %}
                            <i class="fas fa-link text-green-500 mr-2"></i>Blockchain Hash Verification
                            {% elif verification_result.method == 'content_match' %}
                            <i class="fas fa-file-alt text-yellow-500 mr-2"></i>Content Matching
                            {% elif verification_result.method == 'hash_mismatch' %}
                            <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>Hash Mismatch Detected
                            {% elif verification_result.method == 'hash_not_found' %}
                            <i class="fas fa-times text-red-500 mr-2"></i>Hash Not Found on Blockchain
                            {% else %}
                            {{ verification_result.method|title }}
                            {% endif %}
                        </p>
                    </div>
                    
                    <div class="bg-accent/30 rounded-lg p-4">
                        <p class="text-sm text-muted-foreground mb-1">Document Type</p>
                        <p class="font-medium text-foreground">
                            {% if verification_result.is_scanned %}
                            <i class="fas fa-print text-yellow-500 mr-2"></i>Scanned Document
                            {% else %}
                            <i class="fas fa-file-pdf text-blue-500 mr-2"></i>Digital PDF
                            {% endif %}
                        </p>
                    </div>
                </div>

                <!-- Hash Comparison -->
                <div class="mt-4 bg-accent/20 rounded-lg p-4">
                    <h4 class="text-sm font-semibold text-muted-foreground mb-3">Hash Comparison</h4>
                    <div class="space-y-2 font-mono text-xs">
                        <div class="flex items-start">
                            <span class="text-muted-foreground w-28 flex-shrink-0">Uploaded:</span>
                            <span class="text-foreground break-all {% if verification_result.hash_match %}text-green-400{% else %}text-red-400{% endif %}">
                                {{ verification_result.uploaded_hash|default:"N/A" }}
                            </span>
                        </div>
                        <div class="flex items-start">
                            <span class="text-muted-foreground w-28 flex-shrink-0">Original:</span>
                            <span class="text-foreground break-all">
                                {{ verification_result.original_hash|default:"N/A" }}
                            </span>
                        </div>
                    </div>
                    <div class="mt-2 flex items-center justify-between flex-wrap gap-2">
                        <div>
                            {% if verification_result.hash_match %}
                            <span class="inline-flex items-center px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded-full">
                                <i class="fas fa-check mr-1"></i>Hashes Match
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-1 bg-red-500/20 text-red-400 text-xs rounded-full">
                                <i class="fas fa-times mr-1"></i>Hashes Do Not Match
                            </span>
                            {% endif %}
                        </div>
                        {% if verification_result.verified %}
                            {% if prescription.blockchain_tx_hash %}
                            <a href="https://sepolia.etherscan.io/tx/{{ prescription.blockchain_tx_hash }}" 
                               target="_blank" 
                               rel="noopener noreferrer"
                               class="inline-flex items-center px-4 py-2 bg-primary hover:bg-primary/90 text-primary-foreground text-sm font-medium rounded-lg transition-all duration-200 shadow-lg hover:shadow-xl">
                                <i class="fas fa-external-link-alt mr-2"></i>
                                View on Etherscan
                            </a>
                            {% elif verification_result.blockchain_data and contract_address %}
                            <a href="https://sepolia.etherscan.io/address/{{ contract_address }}" 
                               target="_blank" 
                               rel="noopener noreferrer"
                               class="inline-flex items-center px-4 py-2 bg-primary hover:bg-primary/90 text-primary-foreground text-sm font-medium rounded-lg transition-all duration-200 shadow-lg hover:shadow-xl">
                                <i class="fas fa-external-link-alt mr-2"></i>
                                View Contract on Etherscan
                            </a>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>

                <!-- Warnings -->
                {% if verification_result.warnings %}
                <div class="mt-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                    <h4 class="text-sm font-semibold text-yellow-500 mb-2">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Warnings
                    </h4>
                    <ul class="list-disc list-inside text-sm text-yellow-400 space-y-1">
                        {% for warning in verification_result.warnings %}
                        <li>{{ warning }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Content Match Details (for scanned documents) -->
                {% if verification_result.details.content_match %}
                <div class="mt-4 bg-accent/30 rounded-lg p-4">
                    <h4 class="text-sm font-semibold text-muted-foreground mb-2">Content Analysis</h4>
                    <div class="flex items-center space-x-4">
                        <div class="flex-1 bg-accent/50 rounded-full h-4 overflow-hidden">
                            <div class="bg-{% if verification_result.details.content_match.match_percentage >= 70 %}green{% elif verification_result.details.content_match.match_percentage >= 40 %}yellow{% else %}red{% endif %}-500 h-full transition-all duration-500" 
                                 style="width: {{ verification_result.details.content_match.match_percentage }}%"></div>
                        </div>
                        <span class="font-semibold text-foreground">{{ verification_result.details.content_match.match_percentage }}%</span>
                    </div>
                    <p class="text-xs text-muted-foreground mt-2">
                        {{ verification_result.details.content_match.key_fields_found }} of {{ verification_result.details.content_match.total_key_fields }} key fields matched
                    </p>
                </div>
                {% endif %}
            </div>

            <!-- Prescription Details -->
            {% if prescription %}
            <div class="mt-6 pt-6 border-t border-border/50">
                <h3 class="font-semibold text-foreground mb-4">Prescription Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="text-muted-foreground">Prescription ID</p>
                        <p class="font-mono text-foreground">{{ prescription.id }}</p>
                    </div>
                    <div>
                        <p class="text-muted-foreground">Issue Date</p>
                        <p class="text-foreground">{{ prescription.created_at|date:"F j, Y g:i A" }}</p>
                    </div>
                    <div>
                        <p class="text-muted-foreground">Patient</p>
                        <p class="text-foreground">{{ prescription.patient.first_name }} {{ prescription.patient.last_name }}</p>
                    </div>
                    <div>
                        <p class="text-muted-foreground">Issuing Doctor</p>
                        <p class="text-foreground">Dr. {{ prescription.doctor.first_name }} {{ prescription.doctor.last_name }}</p>
                    </div>
                    {% if prescription.blockchain_tx_hash %}
                    <div class="md:col-span-2">
                        <p class="text-muted-foreground mb-2">Blockchain Transaction</p>
                        <p class="font-mono text-xs text-foreground break-all bg-accent/30 rounded-lg p-3">{{ prescription.blockchain_tx_hash }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% elif verification_result.blockchain_data %}
            <!-- Blockchain-Only Verification (prescription not in local database) -->
            <div class="mt-6 pt-6 border-t border-border/50">
                <h3 class="font-semibold text-foreground mb-4">Blockchain Verification Data</h3>
                <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 mb-4">
                    <p class="text-sm text-blue-400">
                        <i class="fas fa-info-circle mr-2"></i>
                        This prescription is verified on the blockchain but not found in local database. This is a valid prescription.
                    </p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    {% if verification_result.details.prescription_id %}
                    <div>
                        <p class="text-muted-foreground">Prescription ID</p>
                        <p class="font-mono text-foreground">{{ verification_result.details.prescription_id }}</p>
                    </div>
                    {% endif %}
                    {% if verification_result.details.timestamp %}
                    <div>
                        <p class="text-muted-foreground">Blockchain Timestamp</p>
                        <p class="text-foreground">{{ verification_result.details.timestamp|date:"F j, Y g:i A" }}</p>
                    </div>
                    {% endif %}
                    {% if verification_result.details.doctor_hash %}
                    <div>
                        <p class="text-muted-foreground">Doctor Hash</p>
                        <p class="font-mono text-xs text-foreground break-all">{{ verification_result.details.doctor_hash }}</p>
                    </div>
                    {% endif %}
                    {% if verification_result.details.patient_hash %}
                    <div>
                        <p class="text-muted-foreground">Patient Hash</p>
                        <p class="font-mono text-xs text-foreground break-all">{{ verification_result.details.patient_hash }}</p>
                    </div>
                    {% endif %}
                </div>
                {% if contract_address %}
                <div class="mt-4 text-center">
                    <a href="https://sepolia.etherscan.io/address/{{ contract_address }}" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       class="inline-flex items-center px-4 py-2 bg-primary hover:bg-primary/90 text-primary-foreground rounded-lg transition-all duration-200">
                        <i class="fas fa-link mr-2"></i>
                        View Smart Contract on Etherscan
                    </a>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Upload Form -->
        {% if not verification_result %}
        <div class="bg-card border border-border/50 rounded-xl p-6">
            <h2 class="text-xl font-semibold text-foreground mb-4 flex items-center">
                <i class="fas fa-upload text-primary mr-2"></i>
                Upload Prescription for Verification
            </h2>
            
            <form method="POST" enctype="multipart/form-data" id="verifyForm">
                {% csrf_token %}
                
                <!-- File Upload Dropzone -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-muted-foreground mb-2">
                        Prescription PDF
                    </label>
                    <div id="dropzone" 
                         class="border-2 border-dashed border-border/50 rounded-xl p-8 text-center hover:border-primary/50 transition-colors cursor-pointer"
                         ondragover="event.preventDefault(); this.classList.add('border-primary', 'bg-primary/5')"
                         ondragleave="this.classList.remove('border-primary', 'bg-primary/5')"
                         ondrop="handleDrop(event)">
                        <div id="dropzoneContent">
                            <i class="fas fa-cloud-upload-alt text-4xl text-muted-foreground mb-4"></i>
                            <p class="text-foreground font-medium mb-2">Drag & drop your PDF here</p>
                            <p class="text-sm text-muted-foreground mb-4">or click to browse files</p>
                            <p class="text-xs text-muted-foreground">Supports: PDF (max 10MB)</p>
                        </div>
                        <div id="selectedFile" class="hidden">
                            <i class="fas fa-file-pdf text-red-500 text-4xl mb-4"></i>
                            <p id="fileName" class="text-foreground font-medium mb-2"></p>
                            <p id="fileSize" class="text-sm text-muted-foreground"></p>
                            <button type="button" onclick="clearFile()" class="mt-4 text-sm text-red-400 hover:text-red-300">
                                <i class="fas fa-times mr-1"></i>Remove
                            </button>
                        </div>
                        <input type="file" name="prescription_pdf" id="fileInput" accept=".pdf" class="hidden" onchange="handleFileSelect(this)">
                    </div>
                </div>

                <!-- Optional Prescription ID -->
                <div class="mb-6">
                    <label for="prescription_id" class="block text-sm font-medium text-muted-foreground mb-2">
                        Prescription ID (optional)
                    </label>
                    <input type="text" name="prescription_id" id="prescription_id"
                           class="w-full px-4 py-3 bg-accent/30 border border-border/50 rounded-lg text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/50 font-mono"
                           placeholder="e.g., f53df226-8e8c-47e4-94c8-295be80e0147">
                    <p class="text-xs text-muted-foreground mt-1">
                        Leave blank to auto-detect from the PDF. Enter manually if auto-detection fails.
                    </p>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="submitBtn"
                        class="w-full px-6 py-4 bg-primary text-primary-foreground rounded-xl font-semibold hover:bg-primary/90 transition-all flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                    <i class="fas fa-shield-alt"></i>
                    <span>Verify Prescription</span>
                </button>
            </form>
        </div>

        <!-- How It Works -->
        <div class="mt-8 bg-card border border-border/50 rounded-xl p-6">
            <h3 class="font-semibold text-foreground mb-4 flex items-center">
                <i class="fas fa-info-circle text-primary mr-2"></i>
                How Verification Works
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="flex items-start space-x-3">
                    <div class="bg-primary/10 rounded-full p-3 flex-shrink-0">
                        <span class="text-primary font-bold">1</span>
                    </div>
                    <div>
                        <h4 class="font-medium text-foreground">Hash Generation</h4>
                        <p class="text-sm text-muted-foreground">We generate a cryptographic fingerprint (SHA-256) of the uploaded PDF</p>
                    </div>
                </div>
                <div class="flex items-start space-x-3">
                    <div class="bg-primary/10 rounded-full p-3 flex-shrink-0">
                        <span class="text-primary font-bold">2</span>
                    </div>
                    <div>
                        <h4 class="font-medium text-foreground">Blockchain Lookup</h4>
                        <p class="text-sm text-muted-foreground">We compare it against the original hash stored on the blockchain</p>
                    </div>
                </div>
                <div class="flex items-start space-x-3">
                    <div class="bg-primary/10 rounded-full p-3 flex-shrink-0">
                        <span class="text-primary font-bold">3</span>
                    </div>
                    <div>
                        <h4 class="font-medium text-foreground">Tampering Detection</h4>
                        <p class="text-sm text-muted-foreground">Any modification will result in a different hash, exposing tampering</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const dropzone = document.getElementById('dropzone');
const fileInput = document.getElementById('fileInput');
const submitBtn = document.getElementById('submitBtn');
const dropzoneContent = document.getElementById('dropzoneContent');
const selectedFile = document.getElementById('selectedFile');

if (dropzone) {
    dropzone.addEventListener('click', () => fileInput.click());
}

function handleDrop(event) {
    event.preventDefault();
    dropzone.classList.remove('border-primary', 'bg-primary/5');
    
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        fileInput.files = files;
        handleFileSelect(fileInput);
    }
}

function handleFileSelect(input) {
    const file = input.files[0];
    if (file) {
        if (!file.name.toLowerCase().endsWith('.pdf')) {
            alert('Please select a PDF file');
            clearFile();
            return;
        }
        if (file.size > 10 * 1024 * 1024) {
            alert('File size must be less than 10MB');
            clearFile();
            return;
        }
        
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = formatFileSize(file.size);
        dropzoneContent.classList.add('hidden');
        selectedFile.classList.remove('hidden');
        submitBtn.disabled = false;
    }
}

function clearFile() {
    fileInput.value = '';
    dropzoneContent.classList.remove('hidden');
    selectedFile.classList.add('hidden');
    submitBtn.disabled = true;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Show loading state on form submit
const verifyForm = document.getElementById('verifyForm');
if (verifyForm) {
    verifyForm.addEventListener('submit', function() {
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Verifying...';
        submitBtn.disabled = true;
    });
}
</script>
{% endblock %}
