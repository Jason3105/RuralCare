{% extends 'base.html' %}
{% load static %}
{% block title %}Medicine &amp; AI Hub{% endblock %}

{% block extra_head %}
<!-- Marked.js for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.0.0/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

<style>
    /* ==== AI ASSISTANT TAB STYLES ==== */
    /* Top Controls Bar */
    #mhpanel-assistant .assistant-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
        padding: 1.25rem 1.5rem;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 0.75rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    #mhpanel-assistant .assistant-controls .control-buttons {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }
    
    #mhpanel-assistant .session-selector {
        flex: 1;
        min-width: 200px;
    }
    
    #mhpanel-assistant .session-selector label {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--muted-foreground);
        margin-bottom: 0.375rem;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    
    #mhpanel-assistant .session-selector select {
        width: 100%;
        padding: 0.625rem 2.5rem 0.625rem 1rem;
        background: var(--background);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        color: var(--foreground);
        font-size: 0.875rem;
        cursor: pointer;
        outline: none;
        transition: all 0.2s;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
    }
    
    #mhpanel-assistant .session-selector select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    #mhpanel-assistant .new-chat-btn,
    #mhpanel-assistant .manage-sessions-btn {
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        color: #fff;
        border: none;
        padding: 0.625rem 1.25rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        white-space: nowrap;
    }
    
    #mhpanel-assistant .manage-sessions-btn {
        background: var(--card);
        color: var(--foreground);
        border: 1px solid var(--border);
    }
    
    #mhpanel-assistant .manage-sessions-btn:hover {
        background: var(--accent);
        border-color: #3b82f6;
        color: #3b82f6;
    }
    
    #mhpanel-assistant .new-chat-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    /* Medical Context Badge */
    #hubContextIndicator {
        padding: 0.75rem 1rem;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: 0.75rem;
        color: var(--foreground);
        font-size: 0.8125rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
    }
    
    #hubContextIndicator i {
        color: #3b82f6;
        font-size: 0.875rem;
    }
    
    #hubContextIndicator .context-text {
        font-weight: 600;
    }
    
    #hubContextIndicator .context-badge {
        background: rgba(16, 185, 129, 0.15);
        color: #059669;
        padding: 0.25rem 0.625rem;
        border-radius: 1rem;
        font-weight: 600;
        font-size: 0.6875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        margin-left: 0.5rem;
    }
    
    #hubContextIndicator .context-badge i {
        color: #10b981;
        font-size: 0.75rem;
    }
    
    /* Chat container - enhanced borders and shadows */
    #mhpanel-assistant .chat-container {
        background: var(--card);
        border: 2px solid var(--border);
        border-radius: 1rem;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
    }
    
    #mhpanel-assistant .chat-header {
        padding: 1rem 1.5rem;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(139, 92, 246, 0.05));
        border-bottom: 2px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    #mhpanel-assistant .chat-header-title {
        font-weight: 700;
        font-size: 1rem;
        color: var(--foreground);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    #mhpanel-assistant .chat-header-title i {
        color: #3b82f6;
    }
    
    #mhpanel-assistant .chat-header-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    #mhpanel-assistant .clear-chat-btn {
        padding: 0.5rem 0.875rem;
        background: var(--card);
        border: 1.5px solid var(--border);
        border-radius: 0.5rem;
        color: var(--muted-foreground);
        font-size: 0.8125rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }
    
    #mhpanel-assistant .clear-chat-btn:hover {
        background: #fee2e2;
        color: #dc2626;
        border-color: #dc2626;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(220, 38, 38, 0.15);
    }
    
    /* Messages container with custom scrollbar */
    #mhpanel-assistant .chat-messages {
        min-height: 60vh;
        max-height: 60vh;
        overflow-y: auto;
        padding: 2rem 1.5rem;
        scroll-behavior: smooth;
        background: var(--background);
    }
    
    #mhpanel-assistant .chat-messages::-webkit-scrollbar {
        width: 8px;
    }
    
    #mhpanel-assistant .chat-messages::-webkit-scrollbar-track {
        background: var(--background);
    }
    
    #mhpanel-assistant .chat-messages::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 4px;
    }
    
    #mhpanel-assistant .chat-messages::-webkit-scrollbar-thumb:hover {
        background: var(--muted-foreground);
    }
    
    #mhpanel-assistant .chat-msg {
        display: flex;
        margin-bottom: 1.5rem;
        animation: chatFadeIn 0.4s ease-out;
    }
    
    @keyframes chatFadeIn {
        from {
            opacity: 0;
            transform: translateY(12px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    #mhpanel-assistant .chat-msg.user {
        justify-content: flex-end;
    }
    
    #mhpanel-assistant .chat-bubble {
        max-width: 75%;
        padding: 1rem 1.25rem;
        border-radius: 1rem;
        line-height: 1.65;
        word-wrap: break-word;
    }
    
    #mhpanel-assistant .chat-msg.user .chat-bubble {
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        color: #fff;
        border-bottom-right-radius: 0.375rem;
        box-shadow: 0 3px 12px rgba(59, 130, 246, 0.35);
        border: 2px solid rgba(255, 255, 255, 0.2);
    }
    
    #mhpanel-assistant .chat-msg.assistant .chat-bubble {
        background: var(--card);
        color: var(--foreground);
        border: 2px solid var(--border);
        border-bottom-left-radius: 0.375rem;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
    }
    
    /* Markdown formatting in assistant messages */
    #mhpanel-assistant .chat-msg.assistant .chat-bubble h1,
    #mhpanel-assistant .chat-msg.assistant .chat-bubble h2,
    #mhpanel-assistant .chat-msg.assistant .chat-bubble h3 {
        font-weight: 700;
        margin: 1em 0 0.5em 0;
        color: var(--foreground);
    }
    
    #mhpanel-assistant .chat-msg.assistant .chat-bubble h1 {
        font-size: 1.4em;
    }
    #mhpanel-assistant .chat-msg.assistant .chat-bubble h2 {
        font-size: 1.25em;
    }
    #mhpanel-assistant .chat-msg.assistant .chat-bubble h3 {
        font-size: 1.1em;
    }
    #mhpanel-assistant .chat-msg.assistant .chat-bubble h1:first-child,
    #mhpanel-assistant .chat-msg.assistant .chat-bubble h2:first-child,
    #mhpanel-assistant .chat-msg.assistant .chat-bubble h3:first-child {
        margin-top: 0;
    }
    
    #mhpanel-assistant .chat-msg.assistant .chat-bubble p {
        margin: 0.75em 0;
    }
    #mhpanel-assistant .chat-msg.assistant .chat-bubble p:first-child {
        margin-top: 0;
    }
    #mhpanel-assistant .chat-msg.assistant .chat-bubble p:last-child {
        margin-bottom: 0;
    }
    
    #mhpanel-assistant .chat-msg.assistant .chat-bubble ul,
    #mhpanel-assistant .chat-msg.assistant .chat-bubble ol {
        margin: 0.75em 0;
        padding-left: 1.5em;
    }
    #mhpanel-assistant .chat-msg.assistant .chat-bubble li {
        margin: 0.4em 0;
    }
    #mhpanel-assistant .chat-msg.assistant .chat-bubble strong {
        font-weight: 700;
        color: var(--foreground);
    }
    #mhpanel-assistant .chat-msg.assistant .chat-bubble em {
        font-style: italic;
    }
    #mhpanel-assistant .chat-msg.assistant .chat-bubble code {
        background: var(--accent);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.9em;
        font-family: 'Courier New', monospace;
        color: #e11d48;
    }
    #mhpanel-assistant .chat-msg.assistant .chat-bubble pre {
        background: var(--accent);
        padding: 12px;
        border-radius: 8px;
        overflow-x: auto;
        margin: 1em 0;
        border-left: 4px solid #3b82f6;
    }
    #mhpanel-assistant .chat-msg.assistant .chat-bubble pre code {
        background: transparent;
        padding: 0;
        color: inherit;
    }
    #mhpanel-assistant .chat-msg.assistant .chat-bubble blockquote {
        border-left: 4px solid #3b82f6;
        padding-left: 16px;
        margin: 1em 0;
        color: var(--muted-foreground);
        font-style: italic;
    }
    #mhpanel-assistant .chat-msg.assistant .chat-bubble a {
        color: #3b82f6;
        text-decoration: underline;
    }
    
    #mhpanel-assistant .chat-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        margin: 0 0.75rem;
        flex-shrink: 0;
        font-size: 0.875rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    #mhpanel-assistant .chat-msg.user .chat-avatar {
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        color: #fff;
    }
    
    #mhpanel-assistant .chat-msg.assistant .chat-avatar {
        background: linear-gradient(135deg, #10b981, #059669);
        color: #fff;
    }
    
    #mhpanel-assistant .chat-time {
        font-size: 0.75rem;
        opacity: 0.65;
        margin-top: 0.5rem;
        font-weight: 500;
    }
    
    #mhpanel-assistant .typing-dots {
        display: flex;
        gap: 5px;
        padding: 12px;
    }
    #mhpanel-assistant .typing-dots span {
        width: 9px;
        height: 9px;
        background: #94a3b8;
        border-radius: 50%;
        animation: tdot 1.4s infinite;
    }
    #mhpanel-assistant .typing-dots span:nth-child(2) {
        animation-delay: .2s;
    }
    #mhpanel-assistant .typing-dots span:nth-child(3) {
        animation-delay: .4s;
    }
    @keyframes tdot {
        0%, 60%, 100% {
            transform: translateY(0);
        }
        30% {
            transform: translateY(-10px);
        }
    }
    
    /* Input bar */
    #mhpanel-assistant .chat-input-bar {
        display: flex;
        gap: 0.75rem;
        padding: 1.25rem 1.5rem;
        border-top: 1px solid var(--border);
        background: var(--card);
    }
    
    #mhpanel-assistant .chat-input-bar textarea {
        flex: 1;
        border: 1px solid var(--border);
        background: var(--background);
        font-size: 0.9375rem;
        outline: none;
        resize: none;
        max-height: 120px;
        font-family: inherit;
        color: var(--foreground);
        padding: 0.875rem 1rem;
        border-radius: 0.75rem;
        transition: all 0.3s;
    }
    
    #mhpanel-assistant .chat-input-bar textarea:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    #mhpanel-assistant .chat-input-bar button {
        padding: 0.875rem 1.5rem;
        border: none;
        border-radius: 0.75rem;
        cursor: pointer;
        font-weight: 600;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        color: #fff;
        transition: all 0.3s;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 60px;
    }
    
    #mhpanel-assistant .chat-input-bar button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    #mhpanel-assistant .chat-input-bar button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    /* Welcome suggestion buttons */
    #mhpanel-assistant .suggestion-btn {
        background: var(--card);
        border: 1px solid var(--border);
        padding: 1rem 1.25rem;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.3s;
        text-align: left;
        color: var(--foreground);
        font-weight: 500;
        font-size: 0.875rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    #mhpanel-assistant .suggestion-btn:hover {
        border-color: #3b82f6;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(139, 92, 246, 0.05));
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    
    #mhpanel-assistant .suggestion-btn i {
        color: #3b82f6;
        font-size: 1.25rem;
        width: 24px;
        text-align: center;
    }
    
    /* Session Management Modal */
    #sessionManagementModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        padding: 1rem;
        animation: fadeIn 0.2s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    #sessionManagementModal.active {
        display: flex;
    }
    
    .session-modal-content {
        background: var(--card, #ffffff);
        border-radius: 1.25rem;
        max-width: 650px;
        width: 100%;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 25px 70px rgba(0, 0, 0, 0.5), 0 10px 30px rgba(0, 0, 0, 0.4);
        border: 1px solid var(--border);
        animation: slideUp 0.3s ease-out;
        overflow: hidden;
    }
    
    .session-modal-header {
        padding: 1.5rem 1.75rem;
        border-bottom: 2px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.06), rgba(139, 92, 246, 0.06));
    }
    
    .session-modal-header h3 {
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0;
        color: var(--foreground);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .session-modal-header h3 i {
        color: #3b82f6;
    }
    
    .session-modal-close {
        background: transparent;
        border: none;
        font-size: 1.5rem;
        color: var(--muted-foreground);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 0.5rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
    }
    
    .session-modal-close:hover {
        color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
    }
    
    .session-modal-body {
        padding: 1.25rem;
        overflow-y: auto;
        flex: 1;
    }
    
    .session-modal-body::-webkit-scrollbar {
        width: 8px;
    }
    
    .session-modal-body::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .session-modal-body::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 4px;
    }
    
    .session-modal-body::-webkit-scrollbar-thumb:hover {
        background: var(--muted-foreground);
    }
    
    .session-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.125rem 1rem;
        background: var(--background);
        border: 2px solid var(--border);
        border-radius: 0.75rem;
        margin-bottom: 0.875rem;
        transition: all 0.2s;
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .session-item:hover {
        background: var(--accent);
        border-color: #3b82f6;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        transform: translateY(-1px);
    }
    
    .session-item.active {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.10));
        border-color: #3b82f6;
        box-shadow: 0 4px 16px rgba(59, 130, 246, 0.25), inset 0 0 0 1px rgba(59, 130, 246, 0.1);
    }
    
    .session-item-info {
        flex: 1;
        min-width: 0;
    }
    
    .session-item-title {
        font-weight: 600;
        font-size: 0.9375rem;
        color: var(--foreground);
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .session-item.active .session-item-title {
        color: #3b82f6;
    }
    
    .session-item-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.75rem;
        color: var(--muted-foreground);
    }
    
    .session-item-actions {
        display: flex;
        gap: 0.5rem;
        margin-left: 1rem;
        flex-shrink: 0;
    }
    
    .session-delete-btn {
        padding: 0.5rem 0.875rem;
        background: var(--card);
        border: 1.5px solid var(--border);
        border-radius: 0.5rem;
        color: var(--muted-foreground);
        font-size: 0.8125rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.375rem;
        white-space: nowrap;
    }
    
    .session-delete-btn:hover {
        background: #fee2e2;
        color: #dc2626;
        border-color: #dc2626;
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(220, 38, 38, 0.2);
    }
    
    .session-delete-btn i {
        font-size: 0.875rem;
    }
    
    /* Empty state in modal */
    .session-modal-body .text-center {
        padding: 3rem 2rem;
    }
    
    .session-modal-body .text-center i {
        display: block;
        font-size: 3.5rem;
        margin-bottom: 1rem;
        color: var(--muted-foreground);
        opacity: 0.3;
    }
    
    .session-modal-body .text-center p {
        color: var(--muted-foreground);
        font-size: 0.9375rem;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
        #mhpanel-assistant .assistant-controls {
            flex-direction: column;
            align-items: stretch;
        }
        #mhpanel-assistant .session-selector {
            min-width: 100%;
        }
        #mhpanel-assistant .control-buttons {
            width: 100%;
            justify-content: stretch;
        }
        #mhpanel-assistant .new-chat-btn,
        #mhpanel-assistant .manage-sessions-btn {
            flex: 1;
            justify-content: center;
        }
        #mhpanel-assistant .chat-messages {
            min-height: 50vh;
            max-height: 50vh;
        }
        .session-item-meta {
            flex-direction: column;
            gap: 0.25rem;
        }
        .session-modal-content {
            max-height: 90vh;
        }
        .session-item {
            flex-direction: column;
            align-items: stretch;
        }
        .session-item-actions {
            margin-left: 0;
            margin-top: 0.75rem;
            justify-content: flex-end;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-background py-8 fade-in">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- Header -->
        <div class="mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-foreground">Medicine &amp; AI Hub</h1>
                    <p class="text-muted-foreground mt-1">Identify medicines, review history, and chat with your Medical AI Assistant</p>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="mb-8 border-b border-border/50">
            <nav class="flex space-x-1 -mb-px" id="medicineTabs">
                <button onclick="switchMedTab('identify')" id="mtab-identify"
                    class="mh-tab px-5 py-3 text-sm font-semibold rounded-t-lg transition-all border-b-2 border-primary text-primary bg-primary/5">
                    <i class="fas fa-capsules mr-2"></i>Identify
                </button>
                <button onclick="switchMedTab('history')" id="mtab-history"
                    class="mh-tab px-5 py-3 text-sm font-semibold rounded-t-lg transition-all border-b-2 border-transparent text-muted-foreground hover:text-foreground hover:border-border">
                    <i class="fas fa-history mr-2"></i>History
                </button>
                <button onclick="switchMedTab('assistant')" id="mtab-assistant"
                    class="mh-tab px-5 py-3 text-sm font-semibold rounded-t-lg transition-all border-b-2 border-transparent text-muted-foreground hover:text-foreground hover:border-border">
                    <i class="fas fa-robot mr-2"></i>AI Assistant
                </button>
            </nav>
        </div>


        <!-- ============================================================ -->
        <!-- TAB 1: IDENTIFY MEDICINE (upload)                            -->
        <!-- ============================================================ -->
        <div id="mhpanel-identify" class="mh-panel">

            <div class="max-w-4xl mx-auto">
                <!-- Upload Card -->
                <div class="bg-card border border-border/50 rounded-2xl shadow-xl overflow-hidden mb-8">
                    <div class="p-8">
                        <form method="POST" action="{% url 'medicine_identifier:upload' %}" enctype="multipart/form-data" id="medUploadForm" class="space-y-6">
                            {% csrf_token %}

                            <!-- Drop Zone -->
                            <div id="medDropZone" class="relative border-2 border-dashed border-border rounded-xl p-12 text-center hover:border-primary transition-all cursor-pointer bg-accent/20">
                                <input type="file" name="image" id="medImageInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" required>

                                <div id="medUploadPlaceholder">
                                    <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-primary/10 flex items-center justify-center">
                                        <i class="fas fa-cloud-upload-alt text-4xl text-primary"></i>
                                    </div>
                                    <h3 class="text-lg font-semibold text-foreground mb-2">Drop your medicine image here</h3>
                                    <p class="text-muted-foreground mb-4">or click to browse</p>
                                    <div class="flex flex-wrap justify-center gap-2 text-sm text-muted-foreground">
                                        <span class="px-2 py-1 bg-accent rounded">JPG</span>
                                        <span class="px-2 py-1 bg-accent rounded">PNG</span>
                                        <span class="px-2 py-1 bg-accent rounded">WEBP</span>
                                        <span class="px-2 py-1 bg-accent rounded">Max 10MB</span>
                                    </div>
                                </div>

                                <div id="medImagePreview" class="hidden">
                                    <img id="medPreviewImg" src="" alt="Preview" class="max-h-64 mx-auto rounded-lg shadow-lg">
                                    <p id="medFileName" class="mt-4 text-foreground font-medium"></p>
                                    <button type="button" id="medRemoveImage" class="mt-2 text-red-500 hover:text-red-600 text-sm">
                                        <i class="fas fa-times mr-1"></i>Remove image
                                    </button>
                                </div>
                            </div>

                            <!-- Supported Medicines Info -->
                            <div class="bg-blue-50 dark:bg-blue-900/30 rounded-xl p-4">
                                <h4 class="font-medium text-blue-800 dark:text-blue-300 mb-2">
                                    <i class="fas fa-info-circle mr-2"></i>Supported Medicine Types
                                </h4>
                                <div class="flex flex-wrap gap-2">
                                    <span class="px-3 py-1 bg-card rounded-full text-sm text-foreground"><i class="fas fa-tablets mr-1 text-blue-500"></i>Tablets</span>
                                    <span class="px-3 py-1 bg-card rounded-full text-sm text-foreground"><i class="fas fa-capsules mr-1 text-purple-500"></i>Capsules</span>
                                    <span class="px-3 py-1 bg-card rounded-full text-sm text-foreground"><i class="fas fa-prescription-bottle mr-1 text-green-500"></i>Syrups</span>
                                    <span class="px-3 py-1 bg-card rounded-full text-sm text-foreground"><i class="fas fa-pump-soap mr-1 text-pink-500"></i>Creams</span>
                                    <span class="px-3 py-1 bg-card rounded-full text-sm text-foreground"><i class="fas fa-syringe mr-1 text-red-500"></i>Injections</span>
                                    <span class="px-3 py-1 bg-card rounded-full text-sm text-foreground"><i class="fas fa-eye-dropper mr-1 text-cyan-500"></i>Drops</span>
                                </div>
                            </div>

                            <!-- Tips -->
                            <div class="bg-amber-50 dark:bg-amber-900/30 rounded-xl p-4">
                                <h4 class="font-medium text-amber-800 dark:text-amber-300 mb-2">
                                    <i class="fas fa-lightbulb mr-2"></i>Tips for Better Results
                                </h4>
                                <ul class="text-sm text-amber-700 dark:text-amber-400 space-y-1">
                                    <li><i class="fas fa-check mr-2 text-amber-500"></i>Use good lighting and avoid shadows</li>
                                    <li><i class="fas fa-check mr-2 text-amber-500"></i>Make sure the medicine name and dosage are clearly visible</li>
                                    <li><i class="fas fa-check mr-2 text-amber-500"></i>Capture the full medicine packaging or label</li>
                                    <li><i class="fas fa-check mr-2 text-amber-500"></i>Avoid blurry or tilted images</li>
                                </ul>
                            </div>

                            <!-- Submit -->
                            <button type="submit" id="medSubmitBtn" class="w-full py-4 px-6 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold rounded-xl transition-all transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                                <span id="medSubmitText"><i class="fas fa-search mr-2"></i>Identify Medicine</span>
                                <span id="medLoadingText" class="hidden"><i class="fas fa-spinner fa-spin mr-2"></i>Analyzing image...</span>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- How It Works -->
                <div class="bg-card border border-border/50 rounded-2xl shadow-xl overflow-hidden mb-8">
                    <div class="p-8">
                        <h2 class="text-xl font-bold text-foreground mb-6 text-center">How It Works</h2>
                        <div class="grid md:grid-cols-3 gap-6">
                            <div class="text-center">
                                <div class="w-14 h-14 mx-auto mb-4 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center">
                                    <span class="text-2xl font-bold text-blue-600 dark:text-blue-400">1</span>
                                </div>
                                <h3 class="font-semibold text-foreground mb-2">Upload Image</h3>
                                <p class="text-sm text-muted-foreground">Take a clear photo of your medicine package, tablet strip, or bottle label</p>
                            </div>
                            <div class="text-center">
                                <div class="w-14 h-14 mx-auto mb-4 rounded-full bg-purple-100 dark:bg-purple-900 flex items-center justify-center">
                                    <span class="text-2xl font-bold text-purple-600 dark:text-purple-400">2</span>
                                </div>
                                <h3 class="font-semibold text-foreground mb-2">AI Analysis</h3>
                                <p class="text-sm text-muted-foreground">Our OpenCV &amp; AI system extracts text and analyzes visual features</p>
                            </div>
                            <div class="text-center">
                                <div class="w-14 h-14 mx-auto mb-4 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center">
                                    <span class="text-2xl font-bold text-green-600 dark:text-green-400">3</span>
                                </div>
                                <h3 class="font-semibold text-foreground mb-2">Get Details</h3>
                                <p class="text-sm text-muted-foreground">Receive comprehensive info about uses, side effects, warnings &amp; more</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Identifications -->
                {% if recent_identifications %}
                <div class="bg-card border border-border/50 rounded-2xl shadow-xl overflow-hidden">
                    <div class="p-6 border-b border-border/50">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-bold text-foreground"><i class="fas fa-history mr-2 text-muted-foreground"></i>Recent Identifications</h2>
                            <button onclick="switchMedTab('history')" class="text-primary hover:underline text-sm">View All <i class="fas fa-arrow-right ml-1"></i></button>
                        </div>
                    </div>
                    <div class="divide-y divide-border/50">
                        {% for item in recent_identifications %}
                        <a href="{% url 'medicine_identifier:result' item.id %}" class="block p-4 hover:bg-accent/50 transition-colors">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-lg overflow-hidden bg-accent flex-shrink-0">
                                    {% if item.image %}
                                    <img src="{{ item.image.url }}" alt="Medicine" class="w-full h-full object-cover">
                                    {% else %}
                                    <div class="w-full h-full flex items-center justify-center"><i class="fas fa-pills text-muted-foreground"></i></div>
                                    {% endif %}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-medium text-foreground truncate">{{ item.medicine_name|default:"Unknown Medicine" }}</h3>
                                    <p class="text-sm text-muted-foreground">{{ item.created_at|date:"M d, Y H:i" }}</p>
                                </div>
                                <div>
                                    {% if item.status == 'completed' and item.identification_confidence >= 0.6 %}
                                    <span class="px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-300 text-xs rounded-full">Identified</span>
                                    {% elif item.status == 'completed' %}
                                    <span class="px-2 py-1 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-300 text-xs rounded-full">Partial</span>
                                    {% elif item.status == 'invalid_image' %}
                                    <span class="px-2 py-1 bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-300 text-xs rounded-full">Invalid</span>
                                    {% elif item.status == 'failed' %}
                                    <span class="px-2 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-300 text-xs rounded-full">Failed</span>
                                    {% else %}
                                    <span class="px-2 py-1 bg-accent text-muted-foreground text-xs rounded-full">{{ item.status|title }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Disclaimer -->
                <div class="mt-8 p-4 bg-yellow-50 dark:bg-yellow-900/30 rounded-xl">
                    <p class="text-sm text-yellow-800 dark:text-yellow-300 text-center">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <strong>Important:</strong> This tool is for informational purposes only. Always consult a healthcare professional before taking any medication.
                    </p>
                </div>
            </div>

        </div><!-- end mhpanel-identify -->


        <!-- ============================================================ -->
        <!-- TAB 2: MEDICINE HISTORY                                      -->
        <!-- ============================================================ -->
        <div id="mhpanel-history" class="mh-panel hidden">

            {% if history_identifications %}
            <div class="bg-card border border-border/50 rounded-2xl shadow-xl overflow-hidden">
                <div class="divide-y divide-border/50">
                    {% for item in history_identifications %}
                    <div class="p-4 sm:p-6 hover:bg-accent/30 transition-colors">
                        <div class="flex flex-col sm:flex-row gap-4">
                            <!-- Image Thumbnail -->
                            <div class="w-full sm:w-24 h-40 sm:h-24 rounded-xl overflow-hidden bg-accent flex-shrink-0">
                                {% if item.image %}
                                <img src="{{ item.image.url }}" alt="Medicine" class="w-full h-full object-cover">
                                {% else %}
                                <div class="w-full h-full flex items-center justify-center"><i class="fas fa-pills text-3xl text-muted-foreground"></i></div>
                                {% endif %}
                            </div>

                            <!-- Details -->
                            <div class="flex-1 min-w-0">
                                <div class="flex flex-col sm:flex-row sm:items-start justify-between gap-2">
                                    <div>
                                        <h3 class="text-lg font-semibold text-foreground">{{ item.medicine_name|default:"Unknown Medicine" }}</h3>
                                        {% if item.generic_name %}
                                        <p class="text-sm text-muted-foreground">{{ item.generic_name }}</p>
                                        {% endif %}
                                    </div>
                                    <div class="flex items-center gap-2 flex-shrink-0">
                                        {% if item.status == 'completed' and item.identification_confidence >= 0.6 %}
                                        <span class="px-3 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-300 text-xs font-medium rounded-full"><i class="fas fa-check mr-1"></i>Identified</span>
                                        {% elif item.status == 'completed' %}
                                        <span class="px-3 py-1 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-300 text-xs font-medium rounded-full"><i class="fas fa-question mr-1"></i>Partial</span>
                                        {% elif item.status == 'invalid_image' %}
                                        <span class="px-3 py-1 bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-300 text-xs font-medium rounded-full"><i class="fas fa-image mr-1"></i>Invalid Image</span>
                                        {% elif item.status == 'failed' %}
                                        <span class="px-3 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-300 text-xs font-medium rounded-full"><i class="fas fa-times mr-1"></i>Failed</span>
                                        {% else %}
                                        <span class="px-3 py-1 bg-accent text-muted-foreground text-xs font-medium rounded-full"><i class="fas fa-spinner fa-spin mr-1"></i>{{ item.status|title }}</span>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="flex flex-wrap gap-4 mt-3 text-sm text-muted-foreground">
                                    {% if item.medicine_form and item.medicine_form != 'unknown' %}
                                    <span><i class="fas fa-pills mr-1"></i>{{ item.medicine_form|title }}</span>
                                    {% endif %}
                                    {% if item.strength %}
                                    <span><i class="fas fa-weight mr-1"></i>{{ item.strength }}</span>
                                    {% endif %}
                                    {% if item.drug_class %}
                                    <span><i class="fas fa-tag mr-1"></i>{{ item.drug_class }}</span>
                                    {% endif %}
                                    <span><i class="fas fa-clock mr-1"></i>{{ item.created_at|date:"M d, Y H:i" }}</span>
                                </div>

                                <!-- Actions -->
                                <div class="flex flex-wrap gap-2 mt-4">
                                    <a href="{% url 'medicine_identifier:result' item.id %}" class="inline-flex items-center px-4 py-2 bg-primary/10 hover:bg-primary/20 text-primary text-sm font-medium rounded-lg transition-colors">
                                        <i class="fas fa-eye mr-2"></i>View Details
                                    </a>
                                    <form method="POST" action="{% url 'medicine_identifier:delete' item.id %}" class="inline" onsubmit="return confirm('Delete this identification?');">
                                        {% csrf_token %}
                                        <button type="submit" class="inline-flex items-center px-4 py-2 bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-700 dark:text-red-300 text-sm font-medium rounded-lg transition-colors">
                                            <i class="fas fa-trash mr-2"></i>Delete
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                {% if history_page.has_other_pages %}
                <div class="px-6 py-4 border-t border-border/50">
                    <nav class="flex justify-center items-center gap-2">
                        {% if history_page.has_previous %}
                        <a href="?page={{ history_page.previous_page_number }}#history" class="px-4 py-2 bg-accent hover:bg-accent/80 text-foreground rounded-lg transition-colors">
                            <i class="fas fa-chevron-left mr-1"></i>Previous
                        </a>
                        {% endif %}
                        <span class="px-4 py-2 text-muted-foreground">
                            Page {{ history_page.number }} of {{ history_page.paginator.num_pages }}
                        </span>
                        {% if history_page.has_next %}
                        <a href="?page={{ history_page.next_page_number }}#history" class="px-4 py-2 bg-accent hover:bg-accent/80 text-foreground rounded-lg transition-colors">
                            Next<i class="fas fa-chevron-right ml-1"></i>
                        </a>
                        {% endif %}
                    </nav>
                </div>
                {% endif %}
            </div>

            {% else %}
            <!-- Empty State -->
            <div class="bg-card border border-border/50 rounded-2xl p-12 text-center">
                <div class="w-20 h-20 bg-accent rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-pills text-4xl text-muted-foreground"></i>
                </div>
                <h2 class="text-2xl font-bold text-foreground mb-4">No Identifications Yet</h2>
                <p class="text-muted-foreground mb-8 max-w-md mx-auto">Upload an image of a medicine on the Identify tab to get started!</p>
                <button onclick="switchMedTab('identify')" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-medium rounded-lg transition-all">
                    <i class="fas fa-camera mr-2"></i>Upload Your First Medicine
                </button>
            </div>
            {% endif %}

        </div><!-- end mhpanel-history -->


        <!-- ============================================================ -->
        <!-- TAB 3: AI ASSISTANT (chat)                                   -->
        <!-- ============================================================ -->
        <div id="mhpanel-assistant" class="mh-panel hidden">

            <div class="max-w-6xl mx-auto">
                <!-- Top Controls -->
                <div class="assistant-controls">
                    <div class="session-selector">
                        <label><i class="fas fa-history mr-1"></i>Current Session</label>
                        <select onchange="hubSwitchSession(this.value)" id="sessionSelect">
                            {% for session in chat_sessions %}
                            <option value="{{ session.id }}" {% if session.id == active_chat_session.id %}selected{% endif %}>
                                {{ session.title }} - {{ session.updated_at|date:"M d, Y" }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="control-buttons">
                        <button onclick="openSessionManagement()" class="manage-sessions-btn">
                            <i class="fas fa-list"></i>
                            <span>Manage</span>
                        </button>
                        <button onclick="hubCreateNewSession()" class="new-chat-btn">
                            <i class="fas fa-plus"></i>
                            <span>New Chat</span>
                        </button>
                    </div>
                </div>

                <!-- Medical Context Badge -->
                <div id="hubContextIndicator">
                    <i class="fas fa-database"></i>
                    <span class="context-text">Medical AI with Full Access to Your Records</span>
                    <span class="context-badge">
                        <i class="fas fa-check-circle"></i>
                        Connected
                    </span>
                </div>

                <!-- Chat Container -->
                <div class="chat-container">
                    <!-- Chat Header -->
                    <div class="chat-header">
                        <div class="chat-header-title">
                            <i class="fas fa-comments"></i>
                            <span id="currentSessionTitle">{{ active_chat_session.title }}</span>
                        </div>
                        <div class="chat-header-actions">
                            <button onclick="clearCurrentChat()" class="clear-chat-btn" title="Clear this conversation">
                                <i class="fas fa-trash-alt mr-1"></i>Clear Chat
                            </button>
                        </div>
                    </div>
                    
                    <div id="hubMessagesContainer" class="chat-messages">
                        {% if not chat_messages %}
                        <div id="hubEmptyState" class="flex flex-col items-center justify-center h-full text-center px-6 py-8">
                            <div class="mb-6 w-24 h-24 rounded-full bg-gradient-to-br from-blue-100 to-purple-100 dark:from-blue-900/20 dark:to-purple-900/20 flex items-center justify-center">
                                <i class="fas fa-robot text-5xl bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent"></i>
                            </div>
                            <h3 class="text-2xl font-bold mb-3 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                                üè• Your Medical AI Assistant
                            </h3>
                            <p class="text-muted-foreground max-w-md mb-6 text-sm leading-relaxed">
                                I have complete access to your medical records including diagnoses, treatments, medications, symptoms, lab results, and consultation history. Ask me anything about your health journey!
                            </p>
                            
                            <!-- Enhanced suggestion buttons -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-w-2xl w-full mt-4">
                                <button onclick="hubSendSuggestion('What is my current diagnosis and treatment status?')" class="suggestion-btn">
                                    <i class="fas fa-stethoscope"></i>
                                    <span>Current Diagnosis & Treatment</span>
                                </button>
                                <button onclick="hubSendSuggestion('What medications am I currently taking and what are they for?')" class="suggestion-btn">
                                    <i class="fas fa-pills"></i>
                                    <span>My Medications</span>
                                </button>
                                <button onclick="hubSendSuggestion('What symptoms have I logged recently?')" class="suggestion-btn">
                                    <i class="fas fa-heartbeat"></i>
                                    <span>Recent Symptoms</span>
                                </button>
                                <button onclick="hubSendSuggestion('Explain my treatment plan in simple terms')" class="suggestion-btn">
                                    <i class="fas fa-clipboard-list"></i>
                                    <span>Treatment Plan</span>
                                </button>
                                <button onclick="hubSendSuggestion('What were the results of my recent lab tests?')" class="suggestion-btn">
                                    <i class="fas fa-vial"></i>
                                    <span>Lab Results</span>
                                </button>
                                <button onclick="hubSendSuggestion('Summarize my recent consultations with doctors')" class="suggestion-btn">
                                    <i class="fas fa-user-md"></i>
                                    <span>Doctor Consultations</span>
                                </button>
                            </div>
                            
                            <p class="mt-8 text-xs text-muted-foreground max-w-lg">
                                <i class="fas fa-shield-alt mr-1 text-blue-500"></i>
                                Your medical data is secure and only used to provide personalized health insights.
                            </p>
                        </div>
                        {% else %}
                        {% for message in chat_messages %}
                        <div class="chat-msg {{ message.role }}">
                            {% if message.role == 'assistant' %}
                            <div class="chat-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="chat-bubble">
                                <div class="message-content">{{ message.content }}</div>
                                <div class="chat-time">{{ message.created_at|date:"g:i A" }}</div>
                            </div>
                            {% else %}
                            <div class="chat-bubble">
                                <div class="message-content">{{ message.content }}</div>
                                <div class="chat-time">{{ message.created_at|date:"g:i A" }}</div>
                            </div>
                            <div class="chat-avatar">{{ request.user.first_name.0|default:"U" }}</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% endif %}

                        <div id="hubTypingRow" class="chat-msg assistant" style="display:none">
                            <div class="chat-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="chat-bubble">
                                <div class="typing-dots"><span></span><span></span><span></span></div>
                            </div>
                        </div>
                    </div>

                    <div class="chat-input-bar">
                        <textarea id="hubChatInput" placeholder="Ask about your health, diagnosis, treatments, medications, symptoms..." onkeydown="hubHandleKey(event)" rows="1"></textarea>
                        <button id="hubSendBtn" onclick="hubSendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

        </div><!-- end mhpanel-assistant -->
        
        <!-- Session Management Modal -->
        <div id="sessionManagementModal">
            <div class="session-modal-content">
                <div class="session-modal-header">
                    <h3><i class="fas fa-history mr-2"></i>Chat History</h3>
                    <button onclick="closeSessionManagement()" class="session-modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="session-modal-body">
                    <div id="sessionListContainer">
                        {% for session in chat_sessions %}
                        <div class="session-item {% if session.id == active_chat_session.id %}active{% endif %}" data-session-id="{{ session.id }}" onclick="selectSessionFromModal('{{ session.id }}')">
                            <div class="session-item-info">
                                <div class="session-item-title">{{ session.title }}</div>
                                <div class="session-item-meta">
                                    <span><i class="fas fa-clock mr-1"></i>{{ session.updated_at|date:"M d, Y g:i A" }}</span>
                                    <span><i class="fas fa-comment mr-1"></i>{{ session.messages.count }} messages</span>
                                </div>
                            </div>
                            <div class="session-item-actions">
                                <button onclick="event.stopPropagation(); deleteSession('{{ session.id }}')" class="session-delete-btn" title="Delete this session">
                                    <i class="fas fa-trash"></i>
                                    Delete
                                </button>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted-foreground py-8">
                            <i class="fas fa-comments text-4xl mb-3 opacity-50"></i>
                            <p>No chat sessions yet. Start a conversation!</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
/* ========== TAB SWITCHING ========== */
function switchMedTab(tab) {
    document.querySelectorAll('.mh-tab').forEach(t => {
        t.className = 'mh-tab px-5 py-3 text-sm font-semibold rounded-t-lg transition-all border-b-2 border-transparent text-muted-foreground hover:text-foreground hover:border-border';
    });
    document.getElementById('mtab-' + tab).className =
        'mh-tab px-5 py-3 text-sm font-semibold rounded-t-lg transition-all border-b-2 border-primary text-primary bg-primary/5';
    document.querySelectorAll('.mh-panel').forEach(p => p.classList.add('hidden'));
    document.getElementById('mhpanel-' + tab).classList.remove('hidden');
    history.replaceState(null, '', '#' + tab);
    if (tab === 'assistant') hubScrollBottom();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}
document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash.replace('#', '');
    if (['identify', 'history', 'assistant'].includes(hash)) switchMedTab(hash);
});

/* ========== UPLOAD (Identify tab) ========== */
document.addEventListener('DOMContentLoaded', function() {
    const dz = document.getElementById('medDropZone');
    const inp = document.getElementById('medImageInput');
    const ph = document.getElementById('medUploadPlaceholder');
    const pv = document.getElementById('medImagePreview');
    const pi = document.getElementById('medPreviewImg');
    const fn = document.getElementById('medFileName');
    const rm = document.getElementById('medRemoveImage');
    const form = document.getElementById('medUploadForm');
    const sbtn = document.getElementById('medSubmitBtn');
    const stxt = document.getElementById('medSubmitText');
    const ltxt = document.getElementById('medLoadingText');

    ['dragenter','dragover','dragleave','drop'].forEach(e => dz.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); }, false));
    ['dragenter','dragover'].forEach(e => dz.addEventListener(e, () => dz.classList.add('border-primary','bg-primary/5'), false));
    ['dragleave','drop'].forEach(e => dz.addEventListener(e, () => dz.classList.remove('border-primary','bg-primary/5'), false));
    dz.addEventListener('drop', e => { if(e.dataTransfer.files.length){inp.files=e.dataTransfer.files; showPrev(e.dataTransfer.files[0]);} }, false);
    inp.addEventListener('change', function(){ if(this.files&&this.files[0]) showPrev(this.files[0]); });
    function showPrev(f){ const r=new FileReader(); r.onload=e=>{pi.src=e.target.result;fn.textContent=f.name;ph.classList.add('hidden');pv.classList.remove('hidden');}; r.readAsDataURL(f); }
    rm.addEventListener('click', e => { e.stopPropagation(); inp.value=''; pi.src=''; fn.textContent=''; ph.classList.remove('hidden'); pv.classList.add('hidden'); });
    form.addEventListener('submit', () => { sbtn.disabled=true; stxt.classList.add('hidden'); ltxt.classList.remove('hidden'); });
});

/* ========== CHAT (AI Assistant tab) ========== */
let hubSessionId = '{{ active_chat_session.id }}';

// Configure marked.js for better rendering
if (typeof marked !== 'undefined') {
    marked.setOptions({
        breaks: true,
        gfm: true,
        headerIds: false,
        mangle: false
    });
}

function hubHandleKey(e){ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();hubSendMessage();} }
function hubSendSuggestion(t){ document.getElementById('hubChatInput').value=t; hubSendMessage(); }
function hubScrollBottom(){ const c=document.getElementById('hubMessagesContainer'); if(c) c.scrollTop=c.scrollHeight; }

// Helper function to render markdown safely
function renderMarkdown(text) {
    if (typeof marked === 'undefined' || typeof DOMPurify === 'undefined') {
        // Fallback: preserve line breaks
        return text.replace(/\n/g, '<br>');
    }
    try {
        const rawHtml = marked.parse(text);
        return DOMPurify.sanitize(rawHtml, {
            ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'code', 'pre', 'blockquote', 'a'],
            ALLOWED_ATTR: ['href', 'title', 'target']
        });
    } catch(e) {
        console.error('Markdown rendering error:', e);
        return text.replace(/\n/g, '<br>');
    }
}

async function hubSendMessage(){
    const inp = document.getElementById('hubChatInput');
    const msg = inp.value.trim();
    if(!msg) return;
    const btn = document.getElementById('hubSendBtn');
    btn.disabled = true;
    hubAddMsg('user', msg);
    inp.value = '';
    inp.style.height = 'auto';
    document.getElementById('hubTypingRow').style.display = '';
    hubScrollBottom();
    try {
        const res = await fetch('{% url "medical_chatbot:send_message" %}',{
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},
            body:JSON.stringify({ message:msg, session_id:hubSessionId })
        });
        const data = await res.json();
        document.getElementById('hubTypingRow').style.display = 'none';
        if(data.success){
            hubAddMsg('assistant', data.assistant_message.content);
            if(data.session_id) hubSessionId = data.session_id;
            if(data.session_title && data.session_title !== 'New Conversation') {
                // Update session title in header
                const headerTitle = document.getElementById('currentSessionTitle');
                if(headerTitle) {
                    headerTitle.textContent = data.session_title;
                }
                // Update in dropdown
                const activeOption = document.querySelector(`#sessionSelect option[value="${hubSessionId}"]`);
                if(activeOption) {
                    const dateStr = activeOption.textContent.split(' - ')[1];
                    activeOption.textContent = data.session_title + (dateStr ? ' - ' + dateStr : '');
                }
            }
        } else {
            hubAddMsg('assistant', '‚ùå **Error**: ' + (data.error||'An unknown error occurred. Please try again.'));
        }
    } catch(err){
        console.error('Chat error:', err);
        document.getElementById('hubTypingRow').style.display = 'none';
        hubAddMsg('assistant', '‚ùå **Connection Error**: Failed to send message. Please check your internet connection and try again.');
    }
    btn.disabled = false;
    inp.focus();
}

function hubAddMsg(role, content){
    const c = document.getElementById('hubMessagesContainer');
    const es = document.getElementById('hubEmptyState');
    if(es) es.remove();
    const d = document.createElement('div');
    d.className = 'chat-msg ' + role;
    const now = new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
    const initial = '{{ request.user.first_name.0|default:"U" }}';
    
    if(role==='assistant'){
        const renderedContent = renderMarkdown(content);
        d.innerHTML = `
            <div class="chat-avatar"><i class="fas fa-robot"></i></div>
            <div class="chat-bubble">
                <div class="message-content">${renderedContent}</div>
                <div class="chat-time">${now}</div>
            </div>
        `;
    } else {
        // User messages - escape HTML but preserve line breaks
        const escapedContent = content.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
        d.innerHTML = `
            <div class="chat-bubble">
                <div class="message-content">${escapedContent}</div>
                <div class="chat-time">${now}</div>
            </div>
            <div class="chat-avatar">${initial}</div>
        `;
    }
    const tr = document.getElementById('hubTypingRow');
    c.insertBefore(d, tr);
    hubScrollBottom();
}

async function hubCreateNewSession(){
    try {
        const res = await fetch('{% url "medical_chatbot:new_session" %}',{method:'POST',headers:{'X-CSRFToken':'{{ csrf_token }}'}});
        const data = await res.json();
        if(data.success) {
            window.location.href = window.location.pathname + '#assistant';
            window.location.reload();
        }
    } catch(e){ 
        console.error('New session error:', e);
        alert('Failed to create new session. Please try again.');
    }
}

async function hubSwitchSession(sid){
    try {
        const res = await fetch('/chatbot/switch-session/'+sid+'/',{method:'POST',headers:{'X-CSRFToken':'{{ csrf_token }}'}});
        const data = await res.json();
        if(data.success){ 
            window.location.href = window.location.pathname + '#assistant';
            window.location.reload();
        }
    } catch(e){ 
        console.error('Switch session error:', e);
        alert('Failed to switch session. Please try again.');
    }
}

// Auto-resize chat input
const ta = document.getElementById('hubChatInput');
if(ta) {
    ta.addEventListener('input', function(){ 
        this.style.height='auto'; 
        this.style.height=Math.min(this.scrollHeight, 120)+'px'; 
    });
    ta.addEventListener('focus', function() { hubScrollBottom(); });
}

// Render existing messages with markdown on load
document.addEventListener('DOMContentLoaded', function() {
    const existingMessages = document.querySelectorAll('#mhpanel-assistant .chat-msg.assistant .message-content');
    existingMessages.forEach(msgEl => {
        const originalText = msgEl.textContent.trim();
        if(originalText) {
            msgEl.innerHTML = renderMarkdown(originalText);
        }
    });
    
    // Scroll to bottom if on assistant tab
    if(window.location.hash==='#assistant') {
        setTimeout(hubScrollBottom, 100);
    }
});

// Scroll on load if on assistant tab
window.addEventListener('load', () => { 
    if(window.location.hash==='#assistant') {
        setTimeout(hubScrollBottom, 100);
    }
});

// Session Management Functions
function openSessionManagement() {
    const modal = document.getElementById('sessionManagementModal');
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeSessionManagement() {
    const modal = document.getElementById('sessionManagementModal');
    modal.classList.remove('active');
    document.body.style.overflow = 'auto';
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    const modal = document.getElementById('sessionManagementModal');
    if(e.target === modal) {
        closeSessionManagement();
    }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if(e.key === 'Escape') {
        closeSessionManagement();
    }
});

function selectSessionFromModal(sessionId) {
    closeSessionManagement();
    hubSwitchSession(sessionId);
}

async function deleteSession(sessionId) {
    if(!confirm('Are you sure you want to delete this chat session? This action cannot be undone.')) {
        return;
    }
    
    try {
        const res = await fetch(`/chatbot/delete-session/${sessionId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        });
        
        const data = await res.json();
        
        if(data.success) {
            // Remove session from modal list
            const sessionItem = document.querySelector(`.session-item[data-session-id="${sessionId}"]`);
            if(sessionItem) {
                sessionItem.remove();
            }
            
            // Remove from dropdown
            const selectOption = document.querySelector(`#sessionSelect option[value="${sessionId}"]`);
            if(selectOption) {
                selectOption.remove();
            }
            
            // If we deleted the active session, reload to create a new one
            if(sessionId === hubSessionId) {
                window.location.href = window.location.pathname + '#assistant';
                window.location.reload();
            } else {
                // Just close the modal
                const remaining = document.querySelectorAll('.session-item').length;
                if(remaining === 0) {
                    closeSessionManagement();
                    window.location.reload();
                }
            }
        } else {
            alert('Failed to delete session: ' + (data.error || 'Unknown error'));
        }
    } catch(err) {
        console.error('Delete session error:', err);
        alert('Failed to delete session. Please try again.');
    }
}

async function clearCurrentChat() {
    if(!confirm('Are you sure you want to clear this conversation? This will delete all messages in this session.')) {
        return;
    }
    
    await deleteSession(hubSessionId);
}

</script>
{% endblock %}
